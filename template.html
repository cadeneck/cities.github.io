<!DOCTYPE html>
<html lang='en'>

<head>
    <!-- Metadata of the map -->
    <meta charset='utf-8' />
    <title>SAI Sample Survey Map</title>
    <meta name='viewport' content='width=device-width, initial-scale=1' />
    <!-- Include Mapbox GL JS library -->
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.js'></script>
    <!-- Include Mapbox GL JS CSS -->
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.css' rel='stylesheet' />
    <!-- Adding charging station icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>

        /* CSS styles for the body, map, manual, log-box, buttons, and markers -- all front end display*/
        body {
            margin: 0;
            padding: 0;
        }

        /* Style for the map container */
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        /* Style for generate info popup box */
        #manual {
            position: absolute;
            left: 20px;
            top: 20px;
            width: 20%;
            max-height: 30%;
            padding: 20px;
            background-color: #fff;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            font-family: sans-serif;
            border: 1px solid #ccc;
            display: none; /* Initially hidden */
        }

        /* Style for the general info panel */
        #instructions {
            position: absolute;
            left: 30px;
            top: calc(40% + 20px);
            width: 20%;
            bottom: 5%;
            padding: 10px;
            background-color: #fff;
            overflow-y: scroll;
            font-family: sans-serif;
            font-size: 16px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #ccc;
        }

        /* old depricated feature from log-box */
        #log-box {
            position: absolute;
            right: 20px;
            top: 20px;
            width: 20%;
            max-height: 30%;
            padding: 20px;
            background-color: #f1f0ef;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            font-family: sans-serif;
            border: 1px solid #f1f0ef;
        }

        /* Style for the charging station popup boxes */
        .info-box {
            position: absolute;
            width: 200px;
            max-height: 40%;
            padding: 20px;
            background-color: #ffffff;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            font-family: sans-serif;
            border: 1px solid #f1f0ef;
            display: none; /* Initially hidden */
        }

        /* Style for the charging station 1 */
        #top-right-info {
            top: 20px;
            right: 20px;
            background-color: #ffe865;

        }

        /* Style for the charging station 2 */
        #bottom-left-info {
            bottom: 20px;
            right: 20px;
            background-color: #c8c8c8;
        }

        /* Style for the charging station star - review stars */
        .stars {
            font-size: 26px; /* Adjust this value to make the stars larger */
            color: #0047AB	;     /* Optional: Change the color of the stars */
        }

        /* old depricated feature from pre-info-box; still useful if a general popup is needed */
        .popup-content {
            max-height: 330px;
            overflow-y: auto;
        }

        /* old depricated feature when emoji markers were used for POIs; still useful if a emojis markers are needed */
        .emoji-marker {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 30px;
            height: 30px;
            text-align: center;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }


        /* depricated feature from log-box button */
        #copy-button {
            margin-top: 10px;
            background-color: #ffffff;
            color: black;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            font-family: cursive;
        }

        /* depricated feature from log-box button */
        #copy-button:hover {
            background-color: #0056b3;
        }

        /* Button formatting used across all panels and popups current */
        .popup-button, .instruction-button {
            background-color: #f1f0ef;
            color: black;
            border: 1px solid black;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.3s;
            font-family: sans-serif;
        }

        /* Button hover color */
        .popup-button:hover, .instruction-button:hover {
            background-color: #0056b3;
        }

    </style>
</head>

<body>

    <!-- Map container -->
    <div id='map'></div>
    <!-- Manual div providing instructions to the user -->
    <div id="manual">
        <h3>Info</h3>
        <!--<p>This map displays pre-set start and end points for your trip.</p>
        <p>Look for the ⚡ symbol to find two available charging stations along your route.</p>
        <p>Click on any station to view more details about it.</p>
        <p>For navigation, simply click on any two points on the map to get the trip duration and route information.</p> -->
    </div>

    <!-- Instructions div displaying general information about the trip -->
    <div id="instructions">
        <h3>General Info</h3>
    </div>

    <!-- Log box to display charging station info -->
    <div id="top-right-info" class="info-box"></div>
    <div id="bottom-left-info" class="info-box"></div>

    <script>
        // Set the Mapbox access token
        mapboxgl.accessToken = 'pk.eyJ1IjoiaGdhem1laCIsImEiOiJjbGx5NzZpc3QwYWZtM2xwcjE3a2J5bjQxIn0.cpUto7a5fO9EgSY2LCjOSQ';
        
        // Initialize the map
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/navigation-day-v1',
            center: [-157.88132425781222,21.33023123189352],
            zoom: 12
        });
        const bounds = [
            [-158.03132425781222,21.27023123189352],
            [-157.73132425781222,21.40023123189352]
        ];
        map.setMaxBounds(bounds);

        // Create and add markers for start and end points
        const startMarker = new mapboxgl.Marker({ color: '#3887be' }).setLngLat([-122.662323, 45.523751]).addTo(map);
        const endMarker = new mapboxgl.Marker({ color: '#f02' }).setLngLat([-122.663584, 45.523751]).addTo(map);

        // Variables to store start and end points
        let startPoint = null;
        let endPoint = null;
        let poiMarkers = [];
        let mapNum = -1; // SET MAP NUMBER, unique identifier for each map

        // Function to add a marker at a specific point on the map
        const instructions = [
            { title: "Current Time", info: "FILL." }, 
            { title: "Address of Origin", info: "FILL." },
            { title: "Address of Destination", info: "FILL." },
            { title: "Distance to Destination", info: "WILL BE DYNAMICALLY FILLED" },
            { title: "Estimated Time to Destination", info: "WILL BE DYNAMICALLY FILLED" },
            { title: "State of Charge of Battery", info: "FILL." },
            { title: "Range of Current Battery", info: "FILL." },
            { title: "Estimated Drive Distance with Current Charge", info: "FILL." },
            { title: "Type of Charging Socket", info: "FILL." },
            { title: "kWh Needed to Fully Charge Your Car", info: "FILL." }
        ];


        // Array to store charging station data
        // SET BOTH SETS OF CHARGING STATION INFO BELOW
        const chargingStations = [
            {
                coordinates: [ , ],
                imageUrl: ' ', //Whatever the image is on plugshare or default no image picture
                name: ' ', //Whatever the name is on plugshare for station

                location: ' ',  //Whatever the location is on plugshare
                originDistance: 'WILL BE DYNAMICALLY FILLED',
                originTime: ' WILL BE DYNAMICALLY FILLED',
                destDistance: ' WILL BE DYNAMICALLY FILLED ',
                destTime: ' WILL BE DYNAMICALLY FILLED',

                // Just plyg type & respective numbers value (no formatting)
                waitTime: [
                        { type: ' ', value: ' ' } 
                    ],
                plugNumb: [
                        { type: ' ', value: '' }
                    ],    
                chargeTime: [
                        { type: ' ', value: ' ' }
                    ],
                socketAvalability: [
                        { type: ' ', value: ' ' }
                    ],

                
                energySource: 'XX% grid, XX% renewable',

                chargingFee: '$X.XX',
                chargingFeeRate: 'per Y',
                parkingFee: '$X.XX',
                parkingFeeRate: 'for Y',

                coffee: 'Yes/No. <br><br> There is a coffee shop in walking distance X.X miles away.',
                grocery: 'Yes/No. <br><br> There is a grocery store in walking distance X.X miles away.',
                sportsClothes: 'Yes/No. <br><br> There is a sports or clothing store in walking distance X.X miles away.',
                
                //The rating can be empty if there is no reviews
                rating: '★ ✰',
                ratingNum: 'X',
                ratingExact: 'X.X'
            },

            // SET SECOND CHARGING STATION INFO example filled out below
            {
                coordinates: [-157.886713, 21.322051],
                imageUrl: 'https://photos.plugshare.com/photos/892031.jpg',
                name: 'Honolulu Exotics Luxury Car Rental & Auto Spa',

                location: '1824 Auiki St, Honolulu, HI 96819, USA',
                originDistance: ' Miles',
                originTime: ' Minutes',
                destDistance: ' Miles ',
                destTime: ' Minutes',

                
                waitTime: [
                        { type: 'J1772', value: '0' },
                        { type: 'NACS', value: '0' }
                    ],
                plugNumb: [
                        { type: 'J1772', value: '1' },
                        { type: 'NACS', value: '1' }
                    ],
                chargeTime: [
                        { type: 'J1772', value: '580' },
                        { type: 'NACS', value: '180' }
                    ],
                socketAvalability: [
                        { type: 'J1772', value: '1' },
                        { type: 'NACS', value: '1' }
                    ],        

                energySource: '95% grid, 5% renewable',

                chargingFee: '$5.00',
                chargingFeeRate: 'per hour',

                parkingFee: '$0.00',
                parkingFeeRate: 'for any amount of time',

                coffee: 'Yes. <br><br> There is a coffee shop in walking distance 0.7 miles away.',
                grocery: 'No. <br><br> There is no grocery store in walking distance.',
                sportsClothes: 'Yes. <br><br> There is a sports or clothing store in walking distance 1.2 miles away.',
                
                rating: '',
                ratingNum: '0',
                ratingExact: '0.0'
            }
        ];

        // Fixed points for emoji markers, charging stations, and POIs
        const fixedPoint1 = {
            lat: chargingStations[0].coordinates[1],
            lng: chargingStations[0].coordinates[0],
            emoji: '📍'
        };
        const fixedPoint2 = {
            lat: chargingStations[1].coordinates[1],
            lng: chargingStations[1].coordinates[0],
            emoji: '📍'
        };


        // Old depricated CSV - locally logged data
         /*
        // Path to the CSV file
        const csvFilePath = 'logBox.csv';

        // CSV writer setup
        const csvWriter = createObjectCsvWriter({
            path: csvFilePath,
            append: fs.existsSync(csvFilePath), // Append if file exists
            header: [
                {id: 'timestamp', title: 'TIMESTAMP'},
                {id: 'actionType', title: 'ACTION_TYPE'},
                {id: 'location', title: 'LOCATION'},
                {id: 'coordinates', title: 'COORDINATES'}
            ]
        });

        // Function to log data
        function logData(actionType, location, coordinates) {
            const timestamp = new Date().toLocaleString();
            csvWriter.writeRecords([{ timestamp, actionType, location, coordinates }])
                .then(() => console.log('Data was added to the CSV file successfully.'));
            console.log(`Timestamp: ${timestamp}, Action: ${actionType}, Location: ${location}, Coordinates: ${coordinates}`);
           return;
        }
        */

        /*
        let dataLog = [];

        function logData(actionType, chargingStation, button, coordinates, map) {
            const entry = {
                timestamp: new Date().toISOString(),
                actionType: actionType,
                chargingStation: chargingStation,
                button: button,
                coordinates: coordinates,
                map: map
            };
            dataLog.push(entry);
            console.log("Data logged:", entry);
        }

        function downloadCSV(data) {
            const csvRows = ["timestamp,actionType,chargingStation,button,coordinates,map"];
            
            for (const row of data) {
                csvRows.push(`"${row.timestamp}","${row.actionType}" ,"${row.chargingStation}","${row.button}","${row.coordinates}","${row.map}"`);
            }

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'logData.csv');
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
        }
        */

        // Function to get the user ID from the URL - Qualtrics ID randomly generated so we can track behaviors across users
        function getUserIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('userID');
        console.log('User ID ATTEMPED');
        }

        const userId = getUserIdFromUrl();
        console.log('User Id:', userId);

        // Modern log which pushes data to the server - local currently for testing sake but could change the fetch command to a live, centeral server
        // Logs the action type (back button, opening button, map click, or charging station click)
        // Logs the charging station name (if applicable - not possible for general info so left N/A)
        // Button info - title of button or what type of back button was clicked
        // Coordinates - where the action took place (only for map clicks)
        // Map number - which map this took place on (data will have all maps so we can track user behavior across maps)
        // UserID - found on the qualtrics page, setup there so we can track user behavior across users
        function logData(actionType, chargingStation, button, coordinates, map) {

            /*
        const entry = {
            userId: userId,
            timestamp: new Date().toISOString(),
            actionType: actionType,
            chargingStation: chargingStation,
            button: button,
            coordinates: coordinates,
            map: map
        };

        fetch('http://localhost:3000/api/logData', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(entry)
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { throw new Error(text) });
            }
            return response.json();
        })
        .then(data => console.log('Data logged:', data))
        .catch(error => console.error('Error logging data:', error));

        console.log("Data logged:", entry);
        */
        }


        // Function to calculate the distance between two points using the Haversine formula
        function haversineDistance(coords1, coords2) {
            const R = 6371; // Radius of the Earth in kilometers
            const dLat = (coords2[1] - coords1[1]) * Math.PI / 180;
            const dLon = (coords2[0] - coords1[0]) * Math.PI / 180;
            const a =
                0.5 - Math.cos(dLat) / 2 +
                Math.cos(coords1[1] * Math.PI / 180) * Math.cos(coords2[1] * Math.PI / 180) *
                (1 - Math.cos(dLon)) / 2;
            return R * 2 * Math.asin(Math.sqrt(a));
        }

        // Function to check if a point is within a buffer zone of a target point
        function checkBufferZone(clickCoords, targetCoords, bufferRadius) {
            const distance = haversineDistance(clickCoords, targetCoords);
            return distance <= bufferRadius;
        }


        // depricated feature: Function to add an emoji marker at a specific point on the map 
        function addEmojiMarker(point) {
            if (window.emojiMarker) {
                window.emojiMarker.remove();
            }
            const el = document.createElement('div');
            el.className = 'emoji-marker';
            el.style.fontSize = '24px';
            el.innerHTML = point.emoji;
            const popup = new mapboxgl.Popup({ offset: 25 })
                .setHTML(`<h4>Fixed Point Information</h4><p>This is a fixed point marked by an emoji 📍 on the map.</p>`);
            window.emojiMarker = new mapboxgl.Marker({ element: el })
                .setLngLat([point.lng, point.lat])
                .setPopup(popup)
                .addTo(map);
            window.emojiMarker.getPopup().open();
            //logAction(`Emoji marker added at: ${point.lng}, ${point.lat}`);
        }

        // depricated feature: Function to add an emoji marker with feedback at a specific point on the map
        function addEmojiMarkerWithFeedback(point, stationName, plugs, encodedImageUrl, buttonElement, poi_type) {
            const poi_emoji = poi_type === 'restaurant' ? '🍴' : '🛒';
            addPOIs(poi_type, '🍴', point.lat, point.lng, stationName);

            const newPopupContent = `
                <p>Nearby ${poi_type}s added to the map! ${poi_emoji}</p>
            `;

            if (window.currentPopup) {
                window.currentPopup.remove();
            }
            const el = buttonElement.closest('.mapboxgl-popup');
            if (el) {
                const coordinates = new mapboxgl.LngLat(point.lng, point.lat);
                const newPopup = new mapboxgl.Popup({ offset: 25, closeOnClick: false })
                    .setLngLat(coordinates)
                    .setHTML(newPopupContent)
                    .addTo(map);
                window.currentPopup = newPopup;
            }
            //logAction(`Nearby ${poi_type}s added for ${stationName}`);
        }

        // Flag allows different colors for charging stations
        let flag = 1;

        // Array to store existing markers for clearing later
        let markers = [];

        // Function to add charging stations to the map
        function addChargingStations() {
            chargingStations.forEach(station => {
                const el = document.createElement('div');
                el.className = 'marker';
                el.style.display = 'flex';
                el.style.flexDirection = 'column';
                el.style.alignItems = 'center';

                // Create an icon element
                const icon = document.createElement('i');
                icon.className = 'fa-solid fa-charging-station';
                icon.style.fontSize = '40px';  // Set icon size
                icon.style.color = flag ? '#9B7A01' : '#303030'; // Toggle color
                flag = !flag;
                el.appendChild(icon);

                // Create a label element for the charging station name
                const label = document.createElement('div');
                label.innerText = station.name; // Ensure each station has a `name` property
                label.style.fontSize = '14px';
                label.style.color = '#ffffff';
                label.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                label.style.padding = '4px 8px';
                label.style.borderRadius = '4px';
                label.style.marginTop = '4px'; // Space between icon and label
                label.style.textAlign = 'center';

                // Append label below the icon
                el.appendChild(label);

                // Add marker to the map with icon centered on the location
                new mapboxgl.Marker({ element: el, anchor: 'center' })
                    .setLngLat(station.coordinates)
                    .addTo(map);
            });
        }

        // This function single handedly generates the content for the charging station popups & their formatting
        function generateBoxContent(station, boxId) {
            const encodedImageUrl = encodeURIComponent(station.imageUrl);

            let waitTimeDetails = station.waitTime.map(item => `The estimated wait time of socket ${item.type} is ${item.value} minutes.`).join('<br><br>');
            let chargeTimeDetails = station.chargeTime.map(item => `The estimated charging time of socket ${item.type} to fully charge your car is ${item.value} minutes.`).join('<br><br>');
            let plugDetails = station.plugNumb.map(item => {
                let availability = station.socketAvalability.find(availItem => availItem.type === item.type);
                let value = Number(item.value); // Convert to a number if necessary
                return `There ${value === 1 ? 'is' : 'are'} ${value} ${value === 1 ? 'socket' : 'sockets'} of type ${item.type} (${availability ? availability.value : 0} available).`;
            }).join('<br><br>');

            return `
                    <h3 style="font-size: 20px; margin-top: 0; margin-bottom: 10px;">${station.name}</h3>
                    <img src="${decodeURIComponent(encodedImageUrl)}" alt="${station.name}" style="width:100%;max-width:300px;">
                    <button class="popup-button" onclick="showMoreInfo('${station.name}', 'location', '<b>Location:</b> <br> ${station.location}.', '${boxId}')">Location</button>
                    <button class="popup-button" onclick="showMoreInfo('${station.name}', 'originDistance', '<b>Distance from my location:</b> ${station.originDistance} ${Number(station.originDistance) === 1 ? 'mile' : 'miles'}. <br><br>The distance from your location to ${station.name} is ${station.originDistance} ${Number(station.originDistance) === 1 ? 'mile' : 'miles'}.', '${boxId}')">Distance from my Location</button>
                    <button class="popup-button" onclick="showMoreInfo('${station.name}', 'originTime', '<b>Travel time from my location:</b> ${station.originTime} ${Number(station.originTime) === 1 ? 'minute' : 'minutes'}. <br><br>The estimated travel time from your location to ${station.name} is ${station.originTime} ${Number(station.originTime) === 1 ? 'minute' : 'minutes'}.', '${boxId}')">Travel Time from my Location</button>
                    <button class="popup-button" onclick="showMoreInfo('${station.name}', 'destDistance', '<b>Distance to destination:</b> ${station.destDistance} ${Number(station.destDistance) === 1 ? 'mile' : 'miles'}. <br><br>The distance from ${station.name} to the destination is ${station.destDistance} ${Number(station.destDistance) === 1 ? 'mile' : 'miles'}.', '${boxId}')">Distance to Destination</button>
                    <button class="popup-button" onclick="showMoreInfo('${station.name}', 'destTime', '<b>Travel time to destination:</b> ${station.destTime} ${Number(station.destTime) === 1 ? 'minute' : 'minutes'}. <br><br>The estimated travel time from  ${station.name} to the destination is ${station.destTime} ${Number(station.destTime) === 1 ? 'minute' : 'minutes'}.', '${boxId}')">Travel Time to Destination</button>
                    
                    <button class="popup-button" onclick="showMoreInfo('${station.name}', 'waitTime', '<b>Wait time at station:</b><br>${waitTimeDetails}', '${boxId}')">Wait Time at Station</button>
                    <button class="popup-button" onclick="showMoreInfo('${station.name}', 'plugs', '<b>Plugs available at station:</b><br>${plugDetails}', '${boxId}')">Plugs Available at Station</button>
                    <button class="popup-button" onclick="showMoreInfo('${station.name}', 'chargeTime', '<b>Charge time:</b><br>${chargeTimeDetails}', '${boxId}')">Charge Time</button>
                    
                    <button class="popup-button" onclick="showMoreInfo('${station.name}', 'energySource', '<b>Energy source at station:</b><br>${station.energySource}.', '${boxId}')">Energy Source at Station</button>
                    <button class="popup-button" onclick="showMoreInfo('${station.name}', 'fees', '<b>Cost to charge:</b> ${station.chargingFee}. <br><br> The price ${station.chargingFeeRate} is ${station.chargingFee.toLowerCase()}.', '${boxId}')">Cost to Charge</button>
                    <button class="popup-button" onclick="showMoreInfo('${station.name}', 'parking', '<b>Cost to park at station:</b> ${station.parkingFee}. <br><br> The price of parking your car at the charging station ${station.parkingFeeRate} is ${station.parkingFee.toLowerCase()}.', '${boxId}')">Cost to Park at Station</button>
                    <button class="popup-button" onclick="showMoreInfo('${station.name}', 'coffee', '<b>Coffee shop:</b> ${station.coffee}', '${boxId}')">Coffee Shop</button>
                    <button class="popup-button" onclick="showMoreInfo('${station.name}', 'grocery', '<b>Grocery store:</b> ${station.grocery}', '${boxId}')">Grocery Store</button>
                    <button class="popup-button" onclick="showMoreInfo('${station.name}', 'sportsClothes', '<b>Sports/Clothing store:</b> ${station.sportsClothes}', '${boxId}')">Sport/Clothing Store</button>
                    <button class="popup-button" onclick="showMoreInfo('${station.name}', 'rating', '', '${boxId}')">Rating</button>
                `;
        }

        // depricated: Function to clear the info boxes
        /*
        function clearInfoBoxes() {
            const infoBoxes = document.querySelectorAll('.info-box');
            infoBoxes.forEach(box => {
                box.innerHTML = '';
                box.style.display = 'none';
            });
            console.log('Cleared info boxes');
        }
            */

        // Since we have two info boxes, we need to clear them individually
        // This happens when a area is clicked outside of the current station popup to close all popups
        function clearInfoBoxes(boxId = null) {
            const infoBoxes = document.querySelectorAll('.info-box');
            infoBoxes.forEach(box => {
                if (boxId === null || box.id === boxId) {
                    box.innerHTML = '';
                    box.style.display = 'none';
                }
            });
            console.log('Cleared info boxes', boxId ? `for ${boxId}` : 'all');
        }



        // Function to update each specific info box with their respective charging station data
        // (using the generateBoxContent, showMoreInfo, and restoreOriginalContent functions)
        function updateInfoBox(station, boxId) {
            const infoBox = document.getElementById(boxId);
            infoBox.innerHTML = generateBoxContent(station, boxId);
            infoBox.style.display = 'block';
            console.log(`Updated info box with data for ${station.name}`);
        }
        

        // Function to show more information about a charging station
        // This function generates the following popup populated with the respective info based on which button is clicked within a charging station
        function showMoreInfo(stationName, infoType, infoContent, boxId) {
            logData(`Button Clicked`, `${stationName}`, `${infoType}`, null, mapNum); // Log the charging station button click event

            const station = chargingStations.find(station => station.name === stationName);
            content = `<p style="font-size: 16px; padding: 5px;">${infoContent}</p>`;

            if (infoType === 'rating') {
                content = `<p style="font-size: 16px; padding: 5px;"><b>Rating:</b> ${station.ratingExact}.<br><span class="stars">${station.rating}</span> <br><br> There average rating is ${station.ratingExact}, with ${station.ratingNum} reviews in total.</p>`;
                console.log('Rating clicked');
            }

            const infoBox = document.getElementById(boxId);
            infoBox.innerHTML = `
                <div style="max-height: 500px; max-width: 400px; padding: 10px;">
                    <h3 style="font-size: 20px; margin-top: 0; margin-bottom: 10px;">${stationName}</h3>
                    ${content}
                    <button class="popup-button" style="font-size: 18px; padding: 10px 20px;" onclick="restoreOriginalContent('${stationName}', '${infoType}', '${boxId}')">Back</button>
                </div>
            `;
        }

        // Function to restore the original content of the info box
        // Returns from the showMoreInfo function to the original content (generateBoxContent - or the main landing page for each station)
        function restoreOriginalContent(stationName, infoType, boxId) {
            const station = chargingStations.find(station => station.name === stationName);
            const infoBox = document.getElementById(boxId);
            infoBox.innerHTML = generateBoxContent(station, boxId);
            logData(`Back Button Clicked`, `${stationName}`, `${infoType}`, null, mapNum); // Log the charging station popup back button click event
        }

        // This function creates the buttons for the general information panel
        function createInstructionButtons() {
            const instructionsDiv = document.getElementById('instructions');
            
            instructions.forEach((instruction, index) => {
                const button = document.createElement('button');
                button.className = 'instruction-button';
                button.textContent = instruction.title;
                button.style.fontSize = '16px';
                button.style.padding = '10px';
                button.style.margin = '5px';
                button.style.width = '100%';
                button.onclick = () => showInstructionInfo(index);
                instructionsDiv.appendChild(button);
            });
        }

        // Function to populates the a popup pannel based on the button clicked in the general information panel
        function showInstructionInfo(index) {
            const instruction = instructions[index];
            logData(`Button Clicked`, null, `${instruction.title}`,  null, mapNum); // Log the instruction button click event

            const content = `<p style="font-size: 16px; padding: 5px;">${instruction.info}</p>`;

            const manualDiv = document.getElementById('manual');
            manualDiv.style.display = 'block';
            if (manualDiv) {
                manualDiv.innerHTML = `
                    <h3 style="font-size: 20px; margin-top: 0; margin-bottom: 10px;">${instruction.title}</h3>
                    ${content}
                    <button class="popup-button" style="font-size: 18px; padding: 10px 20px;" onclick="handleBackButtonClick('${instruction.title}')">Back</button>
                `;
            }
        }

        // Function to handle the back button click in the Map Guide popup (closes popup using restoreMapGuide function)
        function handleBackButtonClick(title) {
            logData(`Back Button Clicked`, null, `${title}`,  null, mapNum); // Log the general info popup back button click event
            restoreMapGuide();
        }

        // Function to restore the original Map Guide content
        function restoreMapGuide() {
            const manualDiv = document.getElementById('manual');
            if (manualDiv) {
                manualDiv.innerHTML = ``;
                manualDiv.style.display = 'none';
            }
        }

        // Call the function to create buttons when the page loads
        createInstructionButtons();

        // Function to get the time to travel between two points
        // Leverages existing Mapbox Directions API to determine validity of route & caluclate distance/time in desired format
        // Allows you to just pass in the start and end points to get the time and distance
        async function getRouteDetails(startPoint, endPoint) {
            if (!startPoint || !endPoint) return null;

            const query = await fetch(
                `https://api.mapbox.com/directions/v5/mapbox/driving/${startPoint.lng},${startPoint.lat};${endPoint.lng},${endPoint.lat}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`,
                { method: 'GET' }
            );
            const json = await query.json();
            console.log(json); // Log the full response to inspect it
            if (!json.routes || json.routes.length === 0) {
                console.error('No route data available');
                return { time: 0, distance: 0 }; // Return default values in case of no route data
            }
            const route = json.routes[0];
            return {
                time: Math.floor(route.duration / 60),  // duration in minutes
                distance: (route.distance / 1000 * 0.621371)  // convert distance from km to miles
            };
        }
      
        // Function to get the time to travel between two points
        // Uses the getRouteDetails function to get the time and distance/time variables and updates the charging station variables
        async function updateChargingStationDetails() {
            // Extract startPoint and endPoint from the source data
            const startPoint = {
                lng: pointSource.data.features[0].geometry.coordinates[0],
                lat: pointSource.data.features[0].geometry.coordinates[1]
            };
            const endPoint = {
                lng: endpointsource.data.features[0].geometry.coordinates[0],
                lat: endpointsource.data.features[0].geometry.coordinates[1]
            };

            for (const station of chargingStations) {
                const stationPoint = { lat: station.coordinates[1], lng: station.coordinates[0] };

                // Fetch origin to charging station details
                const originToStation = await getRouteDetails(startPoint, stationPoint);
                station.originDistance = `${originToStation.distance.toFixed(2)}`;
                station.originTime = `${originToStation.time}`;

                // Fetch charging station to destination details
                const stationToDest = await getRouteDetails(stationPoint, endPoint);
                station.destDistance = `${stationToDest.distance.toFixed(2)}`;
                station.destTime = `${stationToDest.time}`;

                console.log(`Updated station ${station.name} with distance ${station.originDistance} and ${station.destDistance}`);
            }

        }


        // Function to update route instructions distance/time dynamically based on the start and end points
        async function updateAndDisplayRouteInstructions() {
            const startPoint = {
                lng: pointSource.data.features[0].geometry.coordinates[0],
                lat: pointSource.data.features[0].geometry.coordinates[1]
            };

            const endPoint = {
                lng: endpointsource.data.features[0].geometry.coordinates[0],
                lat: endpointsource.data.features[0].geometry.coordinates[1]
            };

            const routeDetails = await getRouteDetails(startPoint, endPoint);


            updateInstructions(routeDetails);
        }

        // Function to update instructions with route details
        // Helper function that actually updates the varaibles in the instructions array
        function updateInstructions(routeDetails) {
            instructions[3].info = `${routeDetails.distance.toFixed(2)} miles.`;
            instructions[4].info = `${routeDetails.time} minutes.`;
        }

        // Function to get the route to travel between any route type
        // Always displaying a route but depends if its default start to end route display or to a given charging station
        // This ensures no matter what the route is always displayed, none overlap, and all are cleared when a new route is selected
        async function getRoute(routeType) {
            console.log(`Get route for type ${routeType}`);

            let startPoint, midPoint, endPoint;

            // Set the start and end points from pointSource and endpointsource as used in case 1
            startPoint = {
                lng: pointSource.data.features[0].geometry.coordinates[0],
                lat: pointSource.data.features[0].geometry.coordinates[1]
            };
            endPoint = {
                lng: endpointsource.data.features[0].geometry.coordinates[0],
                lat: endpointsource.data.features[0].geometry.coordinates[1]
            };

            switch (routeType) {
                case 1:
                    // Use the first charging station for case 1
                    midPoint = {
                        lng: chargingStations[0].coordinates[0],
                        lat: chargingStations[0].coordinates[1]
                    };
                    await fetchAndDisplayRoute(startPoint, midPoint, '#FFDF00'); // Fetch route to charging station
                    await fetchAndDisplayRoute(midPoint, endPoint, '#FFDF00');  // Fetch route from charging station to end
                    break;
                case 2:
                    // Use the second charging station for case 2
                    midPoint = {
                        lng: chargingStations[1].coordinates[0],
                        lat: chargingStations[1].coordinates[1]
                    };
                    await fetchAndDisplayRoute(startPoint, midPoint, '#555555'); // Fetch route to charging station
                    await fetchAndDisplayRoute(midPoint, endPoint, '#555555');  // Fetch route from charging station to end
                    break;
                default:
                    // Direct route from startPoint to endPoint
                    await fetchAndDisplayRoute(startPoint, endPoint, '#ca5cdd');
                    return;
            }
        }

    
        // Function to fetch and display a route between two points
        // Can choose even the color of the route line with the third passed variable + handles all the API display
        async function fetchAndDisplayRoute(start, end, color) {
            console.log(`Fetching route from ${start.lng},${start.lat} to ${end.lng},${end.lat}`);

            // Fetch the route data from the Mapbox Directions API
            const query = await fetch(
                `https://api.mapbox.com/directions/v5/mapbox/driving/${start.lng},${start.lat};${end.lng},${end.lat}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`,
                { method: 'GET' }
            );
            const json = await query.json();
            const data = json.routes[0];
            const route = data.geometry.coordinates;
            const geojson = {
                type: 'Feature',
                properties: {},
                geometry: {
                    type: 'LineString',
                    coordinates: route
                }
            };

            // Display the route on the map
            const routeId = `route-${start.lng}-${start.lat}-${end.lng}-${end.lat}`;
            if (map.getSource(routeId)) {
                map.getSource(routeId).setData(geojson);
            } else {
                map.addLayer({
                    id: routeId,
                    type: 'line',
                    source: {
                        type: 'geojson',
                        data: geojson
                    },
                    layout: {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    paint: {
                        'line-color': color,
                        'line-width': 5,
                        'line-opacity': 0.75
                    }
                });
            }
        }

        // Function to remove all route layers from the map
        // This function is called when a new route is selected to ensure no overlapping routes
        function removeRoutes() {
            // This function will need to remove any route layers added to the map
            // Example:
            map.getStyle().layers.forEach(layer => {
                if (layer.id.startsWith('route-')) {
                    map.removeLayer(layer.id);
                    map.removeSource(layer.id);
                }
            });
        }

        // depricated: Function to add points of interest (POIs) to the map
        async function addPOIs(searchTerm, emoji, latitude, longitude, station_name) {
            //logAction(`Adding POIs for ${station_name} - ${searchTerm}`);

            const startPoint = { lat: latitude, lng: longitude };

            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(searchTerm)}.json?type=poi&proximity=${longitude},${latitude}&access_token=${mapboxgl.accessToken}`;
            const response = await fetch(url);
            const data = await response.json();

            for (const feature of data.features) {
                const [lng, lat] = feature.geometry.coordinates;
                const endPoint = { lat, lng };

                const duration = await getTime(startPoint, endPoint);

                const el = document.createElement('div');
                el.innerHTML = emoji;
                el.style.fontSize = '24px';

                const marker = new mapboxgl.Marker({ element: el })
                    .setLngLat([lng, lat])
                    .setPopup(new mapboxgl.Popup({ offset: 25 })
                        .setHTML(`<h3>${feature.text}</h3><p>${feature.place_name}</p>
                        <h4>Travel time to ${station_name}: ${duration} min</h4>`))
                    .addTo(map)
                    .on('click', () => {
                        //logAction(`POI clicked: ${feature.text}`);
                    });

                poiMarkers.push({ marker, coordinates: [lng, lat], logMessage: `Clicked within buffer zone of POI: ${feature.text}` });
            }
        }

        // Define sources for start and end points
        // SET START AND END POINTS BELOW
        const pointSource = {
            type: 'geojson',
            data: {
                type: 'FeatureCollection',
                features: [
                    {
                        type: 'Feature',
                        properties: {
                            title: 'Start'
                        },
                        geometry: {
                            type: 'Point',
                            coordinates: [XX.XXXXXX,XX.XXXXXX]
                        }
                    }
                ]
            }
        };

        //Having a filled example below for the start and end points
        const endpointsource = {
            type: 'geojson',
            data: {
                type: 'FeatureCollection',
                features: [
                    {
                        type: 'Feature',
                        properties: {
                            title: 'End'
                        },
                        geometry: {
                            type: 'Point',
                            coordinates: [-157.88242783693676,21.306019426515576]
                        }
                    }
                ]
            }
        };

        // Add route time/distance to instructions & update charging station details
        // Route zero is default start to end route
        map.on('load', async () => {
            await getRoute(0); // Ensure this is awaited properly
            await updateAndDisplayRouteInstructions();  // Ensure this is awaited properly
            await updateChargingStationDetails();  // Ensure this is awaited properly
            addChargingStations();  // You might need to re-add stations to reflect updated data
        });

        // Add event listeners to the map after it has loaded
        map.on('load', () => {
            // Event listener for map clicks
            map.on('click', (event) => {
                const clickCoords = [event.lngLat.lng, event.lngLat.lat];
                logData(`Map Clicked`, null, null, clickCoords, mapNum); // Log the map click event anywhere
                console.log(`Map clicked at: ${clickCoords}`);

                // Buffer radius for charging stations so popup & route is only shown when clicked within the buffer zone
                // Could be changed with the most recent addition the new charging station graphic but for now set manually based on each maps needs
                const bufferRadius = X.X; // Buffer radius must be uniquley set for each charging station

                // Check if the click is within the buffer zone of a charging station
                // If not, remove existing routes and display the default route
                if(!checkBufferZone(clickCoords, chargingStations[0].coordinates, bufferRadius) && !checkBufferZone(clickCoords, chargingStations[1].coordinates, bufferRadius)) {
                    removeRoutes();
                    getRoute(0);
                    clearInfoBoxes();
                    console.log('Current route type set to 0');
                }

                // Check if the click is within the buffer zone of a charging station
                // If so remove existing routes, display the route to the selected station, and update the info box (popup)
                chargingStations.forEach(station => {
                    if (checkBufferZone(clickCoords, station.coordinates, bufferRadius)) {
                        removeRoutes();
                        getRoute(chargingStations.indexOf(station) + 1);

                        // Clear the relevant info box before updating it
                        const currentBoxId = chargingStations.indexOf(station) + 1 === 1 ? 'top-right-info' : 'bottom-left-info';
                        const otherBoxId = currentBoxId === 'top-right-info' ? 'bottom-left-info' : 'top-right-info';

                        clearInfoBoxes(otherBoxId);

                        // Update the relevant info box based on the station's index
                        updateInfoBox(station, currentBoxId);

                        logData(`Station Opened`, station.name, null, station.coordinates, mapNum); // Log the charging station popup open event (event clicked)
                        console.log(`Clicked within buffer zone of ${station.name}`);
                    }
                });


            });


            // Add charging stations to the map
            addChargingStations();


            // Add layers for start and end points
            map.addLayer({
                id: 'point',
                type: 'circle',
                source: pointSource,
                paint: {
                    'circle-radius': 15,
                    'circle-color': '#3887be'
                }
            });
            map.addLayer({
                id: 'point-label',
                type: 'symbol',
                source: pointSource,
                layout: {
                    'text-field': '{title}',
                    'text-size': 24,
                    'text-anchor': 'left',
                    'text-offset': [0.8, 0]
                },
                paint: {
                    'text-color': 'black'
                }
            });

            map.addLayer({
                id: 'endpoint',
                type: 'circle',
                source: endpointsource,
                paint: {
                    'circle-radius': 15,
                    'circle-color': '#f02'
                }
            });
            map.addLayer({
                id: 'endpoint-label',
                type: 'symbol',
                source: endpointsource,
                layout: {
                    'text-field': '{title}',
                    'text-size': 24,
                    'text-anchor': 'left',
                    'text-offset': [0.8, 0]
                },
                paint: {
                    'text-color': 'black'
                }
            });
        });
    </script>
</body>

</html>